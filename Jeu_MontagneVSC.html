<!doctype html> 
<html lang="en"> 
<head> 
    <meta charset="UTF-8" />
    <title>A Slime's journey</title>
    <script src="//cdn.jsdelivr.net/npm/phaser@3.11.0/dist/phaser.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>
    
<script type="text/javascript">

var config = {
        type: Phaser.AUTO,
        width: 1920,
        height:1080,
        physics: {
            default: 'arcade',
            arcade: {
                gravity: { y: 200 },
                debug: true
            }
        },
        scene: {
            preload: preload,
            create: create,
            update: update
        }
    };
    
var player;
var Roger1;
var Roger2;
var Roger3;
var Roger4;
var Roger5;
var Myreille1;
var Myreille2;
var Myreille3;
var projectile;
var platforms;
//var grimpette;
//var grimpette_player=false;
var cursors;
var HpSlime = 3;
var scoreText;
var tween;


var game = new Phaser.Game(config);
    
    var jump =0;
    
    function preload()
        {
            this.load.image('tiles','assets/Tiles/Map.png');
            this.load.tilemapTiledJSON('map','assets/Tiles/mapmountain.json');

            this.load.image('sky', 'assets/Ciel.png');
            this.load.image('ground', 'assets/platforms.png');
            this.load.image('Decor', 'assets/Montagne_Finis.png');
            this.load.image('Slime','assets/Slime.png')
            this.load.spritesheet('Roger','assets/Sprite_sheet_Roger.png',{frameWidth:139.9,frameHeight:118});
            this.load.spritesheet('Myreille','assets/Sprite_sheet_Myreille.png',{frameWidth:436,frameHeight:460});
            this.load.spritesheet('projectile','assets/projectile.png',{frameWidth:32,frameHeight:32});
            //this.load.image('bomb', 'assets/bomb.png');
            //this.load.spritesheet('dude', 'assets/mario_dude.png', { frameWidth: 32, frameHeight: 48 });
            //this.load.spritesheet('dude', 'assets/.png', { frameWidth: 32, frameHeight: 48 });
        
        
    }
    function create ()
    {
            //Fade de la caméra pour dévoiler le monde
            this.cameras.main.fadeIn(3500);
            cursors = this.input.keyboard.createCursorKeys();

            //Camera qui suit le joueur
            this.cameras.main.setBounds(0, 0, 1920 * 2, 1080 * 2);
            this.physics.world.setBounds(0, 0, 1920 * 2, 1080 * 2);
           
            //loading des images et de la physique
            this.add.image(400,300, 'sky');
            this.add.image(400,300,'Decor');
            const map = this.make.tilemap({key:'map'});
            const tileset = map.addTilesetImage('tilesmap','tiles');

            map.createDynamicLayer('Décors',tileset);
            wallsLayer = map.createDynamicLayer('Plateformes',tileset);
        

            






            //this.physics.arcade.collide(this.player, this.platforms, this.setFriction, null, this);
        player = this.physics.add.sprite(100, 450, 'Slime');
        this.cameras.main.startFollow(player);
        player.setBounce(0.2);
        player.setOffset(0,0);

        player.setCollideWorldBounds(true);
        
        platforms = this.physics.add.staticGroup();
        platforms.create(100,510,'ground');
        //Le slime peut escalader les parois

        //platforms_grimpette = Map.createDynamicLayer('grimpette',tileset,0,0);
        //platforms_grimpette.setCollisionByExclusion(-1,true);
        //platforms_grimpette.setCollisionByProperty({collides:true});

        //Apparition des ennemis.
        Roger1 = this.physics.add.sprite(100,210,'Roger').setScale(1.5,1.5).setSize(80,60).setOffset(0,60).setFlipX(true);
        Roger2 = this.physics.add.sprite(100,210,'Roger').setScale(1.5,1.5).setSize(80,60).setOffset(0,60).setFlipX(true);
        Roger3 = this.physics.add.sprite(100,210,'Roger').setScale(1.5,1.5).setSize(80,60).setOffset(0,60).setFlipX(true);
        Roger4 = this.physics.add.sprite(100,210,'Roger').setScale(1.5,1.5).setSize(80,60).setOffset(0,60).setFlipX(true);
        Roger5 = this.physics.add.sprite(100,210,'Roger').setScale(1.5,1.5).setSize(80,60).setOffset(0,60).setFlipX(true);
        Myreille1 = this.physics.add.sprite(150,260,'Myreille').setScale(0.5,0.5).setSize(250,225).setOffset(90,200);
        Myreille2 = this.physics.add.sprite(150,260,'Myreille').setScale(0.5,0.5).setSize(250,225).setOffset(90,200);
        Myreille3 = this.physics.add.sprite(150,260,'Myreille').setScale(0.5,0.5).setSize(250,225).setOffset(90,200);
        projectile = this.physics.add.sprite(150,300,'projectile');
        //Empecher les Corps de partir du monde
        Roger1.setCollideWorldBounds(true);
        Roger2.setCollideWorldBounds(true);
        Roger3.setCollideWorldBounds(true);
        Roger4.setCollideWorldBounds(true);
        Roger5.setCollideWorldBounds(true);
        Myreille1.setCollideWorldBounds(true);
        Myreille2.setCollideWorldBounds(true);
        Myreille3.setCollideWorldBounds(true);
        projectile.setCollideWorldBounds(true);
        //Suppression des ennemis et projectiles au contact du slime
        this.physics.add.overlap(player,Roger1,CollisionRoger1,null,this);
        this.physics.add.overlap(player,Roger2,CollisionRoger2,null,this);
        this.physics.add.overlap(player,Roger3,CollisionRoger3,null,this);
        this.physics.add.overlap(player,Roger4,CollisionRoger4,null,this);
        this.physics.add.overlap(player,Roger5,CollisionRoger5,null,this);
        this.physics.add.overlap(player,Myreille1,CollisionMyreille1,null,this);
        this.physics.add.overlap(player,Myreille2,CollisionMyreille2,null,this);
        this.physics.add.overlap(player,Myreille3,CollisionMyreille3,null,this);
        this.physics.add.overlap(player,projectile,Collisionprojectile,null,this);


        //Affichage des points de vie
        scoreText = this.add.text(16, 16,HpSlime, { fontSize: '32px', fill: '#777' });


        // Animation des Spritesheets//

        this.anims.create({
            key:'Moving.Left',
            frames:this.anims.generateFrameNumbers('Roger',{start : 0, end : 9}),
            frameRate: 10,
            repeat: -1
        });

        this.anims.create({
            key:'Moving.Right',
            frames:this.anims.generateFrameNumbers('Myreille',{start : 0, end : 9}),
            frameRate: 8,
            repeat: -1

        });
        /*this.anims.create({
            key:'Moving.Right',
            frames:this.anims.generateFrameNumbers('Roger',{start : 10, end : 19}),
            frameRate: 10,
            repeat: -1

        });*/

        /*this.anims.create({
            key: 'left',
            frames: this.anims.generateFrameNumbers('Slime', { start: 0, end: 3 }),
            frameRate: 10,
            repeat: -1
        });*/

        /*this.anims.create({
            key: 'turn',
            frames: [ { key: 'Slime', frame:  } ],
            frameRate: 20
        });

        this.anims.create({
            key: 'right',
            frames: this.anims.generateFrameNumbers('Slime', { start: 5, end: 8 }),
            frameRate: 10,
            repeat: -1
        });
            
            platforms = this.physics.add.staticGroup();
        //Fonction pause Exemple Phaser   
        /*this.tweens.add({
            targets: image1,
            props: {
                x: { value: 700, duration: 4000, flipX: true },
                y: { value: 500, duration: 8000,  },
            },
            ease: 'Sine.easeInOut',
            yoyo: true,
            repeat: -1
        });*/
        
        var text = this.add.text(180, 0, 'Pause').setFont('32px Arial Black').setFill('#ffffff').setShadow(2, 2, "#333333", 2);
        
        this.input.on('gameobjectup', function (pointer, gameobject) {
        if (gameobject === downButton && tweens.timeScale > 0)
        {
            tweens.pauseAll();
        
            text.setText('Pause All');
        }
        else if (gameobject === upButton && tweens.timeScale < 9.9)
        {
            tweens.resumeAll();
        
            text.setText('Resume All');
        }
        });
        //Controles Manettes
        //    if (this.input.gamepad.total === 0);
        //{
        //    (text = this.add.text(10, 10, 'Press any button on a connected Gamepad', { font: '16px Courier', fill: '#00ff00' }));

        //  this.input.gamepad.once('connected', function (pad) {

        //        console.log('connected', pad.id);

        //        for (var i = 0; i < this.input.gamepad.total; i++)
                //{
        //            sprites.push(this.add.sprite(Phaser.Math.Between(200, 600), Phaser.Math.Between(100, 500), 'elephant'));
        //        }

        //        text.destroy();

        //    },);
        //else {
        //    for (var i = 0; i < this.input.gamepad.total; i++)
        //    {
        //        sprites.push(this.add.sprite(Phaser.Math.Between(200, 600), Phaser.Math.Between(100, 500), 'elephant'));
        //    }
        //}

        //Collisions avec Objets et Plateformes.   
            cursors = this.input.keyboard.createCursorKeys();
            
            //Empeche les corps de traverser les plateformes
            this.physics.add.collider(player,platforms);
            this.physics.add.collider(Roger1,platforms);
            this.physics.add.collider(Roger2,platforms);
            this.physics.add.collider(Roger3,platforms);
            this.physics.add.collider(Roger4,platforms);
            this.physics.add.collider(Roger5,platforms);
            this.physics.add.collider(Myreille1,platforms);
            this.physics.add.collider(Myreille2,platforms);
            this.physics.add.collider(Myreille3,platforms);
            this.physics.add.collider(projectile,platforms);

            //this.physics.add.collider(player,grimpette);
            //Manque la plateforme de glace et la roche de côté sur cette ligne.
            //this.physics.add.collider(coins, platforms);
            //recolte des items.
            //this.physics.add.overlap(player, coins, collectcoins, null, this);
            //setFriction: function setFriction (player, platform) {
        //friction sur la Glace. Important. 
        //if (platform.key === 'ice-platform')
        //{
            //player.body.x -= platform.body.x - platform.body.prev.x;
        //}
            //}
        //}

        // Déplacement des ennemis //
        
        tween= this.tweens.add({
            targets:Roger1,
            props:{
                x: {value:200,duration:2000,flipX:true},

            },
            yoyo:true,
            delay:20,
            repeat: -1
        });

        tween= this.tweens.add({
            targets:Roger2,
            props:{
                x: {value:200,duration:2000,flipX:true},

            },
            yoyo:true,
            delay:20,
            repeat: -1
        });
        tween= this.tweens.add({
            targets:Roger3,
            props:{
                x: {value:200,duration:2000,flipX:true},

            },
            yoyo:true,
            delay:20,
            repeat: -1
        });
        tween= this.tweens.add({
            targets:Roger4,
            props:{
                x: {value:200,duration:2000,flipX:true},

            },
            yoyo:true,
            delay:20,
            repeat: -1
        });
        tween= this.tweens.add({
            targets:Roger5,
            props:{
                x: {value:200,duration:2000,flipX:true},

            },
            yoyo:true,
            delay:20,
            repeat: -1
        });
    }


    
    function update ()
        {
        //Contrôles Clavier.
            /*if (cursors.left.isDown)
            { 
        
                player.setVelocityX(-160);

                //player.anims.play('left', true);
            }
            else if (cursors.right.isDown)
            {
                player.setVelocityX(160);

                //player.anims.play('right', true);
            }
            else
            {
                player.setVelocityX(0);

                //player.anims.play('turn');
            }

            if (cursors.up.isDown && player.body.touching.down)
            {
                player.setVelocityY(-330);
            }*/
            //Animation des SpriteSheet// Plus déplacements.
            if (cursors.left.isDown)
            {
                Roger1.anims.play('Moving.Left',true);
                Roger2.anims.play('Moving.Left',true);
                Roger3.anims.play('Moving.Left',true);
                Roger4.anims.play('Moving.Left',true);
                Roger5.anims.play('Moving.Left',true);
                Myreille1.anims.play('Moving.Right',true);
                Myreille2.anims.play('Moving.Right',true);
                Myreille3.anims.play('Moving.Right',true);
                player.setAccelerationX(-160);
            

                //player.anims.play('left', true);
            }
            else if (cursors.right.isDown)
            {
                player.setAccelerationX(160);

                //player.anims.play('right', true);
            }
            else
            {
                player.setAccelerationX(0);

                //player.anims.play('turn');
            }

            if (cursors.up.isDown && player.body.touching.down)
            {
                player.setVelocityY(-200);
            }

            //if (cursors.up.isDown)}
            



        /*const didPressJump = Phaser.Input.Keyboard.JustDown(this.keys.up);

        // player can only double jump if the player just jumped
        if (didPressJump) {
            if (player.body.onFloor()) {
                // player can only double jump if it is on the floor
                this.canDoubleJump = true;
                player.body.setVelocityY(-100);
            } 
            else if (this.canDoubleJump) {
                // player can only jump 2x (double jump)
                this.canDoubleJump = false;
                player.body.setVelocityY(-100);
            }   
        }
        var standing = this.player.body.blocked.down || this.player.body.touching.down;
        if (!standing && this.wasStanding)
        {
            this.edgeTimer = this.time.time + 250;
        }
        //contrôles Manettes#1
        //var pads = this.input.gamepad.gamepads;

            //for (var i = 0; i < pads.length; i++)
            {
                var gamepad = pads[i];

                if (!gamepad)
                {
                    continue;
                }

                var sprite = sprites[i];

                if (gamepad.left)
                {
                    sprite.x -= 4;
                    sprite.flipX = false;
                }
                else if (gamepad.right)
                {
                    sprite.x += 4;
                    sprite.flipX = true;
                }

                if (gamepad.up)
                {
                    sprite.y -= 4;
                }
                else if (gamepad.down)
                {
                    sprite.y += 4;
                }
            }*/
    };



    //Fonction qui fait disparaître les Items récoltables.
    //function collectItems (player, coins)
    //{
    //coins.disableBody(true, true);

    //coins += 10;
    //scoreText.setText('Coins: ' + coins);

    //if (coins.countActive(true) === 0)
    //{
        //coins.children.iterate(function (child) {

            //child.enableBody(true, child.x, 0, true, true);

        //});

        //var x = (player.x < 400) ? Phaser.Math.Between(400, 800) : Phaser.Math.Between(0, 400);

        
    //Collision Ennemis Contre Slime. Retrait des points de vie//
    function CollisionRoger1(){

            HpSlime -= 1;
            console.log(HpSlime);
            Roger1.destroy();
       
    }
    function CollisionRoger2(){

            HpSlime -= 1;
            console.log(HpSlime);
            Roger2.destroy();

    }
    function CollisionRoger3(){

            HpSlime -= 1;
            console.log(HpSlime);
            Roger3.destroy();

    }
    function CollisionRoger4(){

            HpSlime -= 1;
            console.log(HpSlime);
            Roger4.destroy();

    }
    function CollisionRoger5(){

            HpSlime -= 1;
            console.log(HpSlime);
            Roger5.destroy();

    }
    function CollisionMyreille1(){

            HpSlime -= 1;
            console.log(HpSlime);
            Myreille1.destroy();
    }
    function CollisionMyreille2(){

            HpSlime -= 1;
            console.log(HpSlime);
            Myreille2.destroy();
    }
    function CollisionMyreille3(){

            HpSlime -= 1;
            console.log(HpSlime);
            Myreille3.destroy();
    }
    function Collisionprojectile(){

            HpSlime -= 1;
            console.log(HpSlime);
            projectile.destroy();
    }
    
</script>
</body>
</html>

    

    
